<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì‹œê°„ íˆ¬í‘œí•˜ê¸°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background-color: black;
    }

    .form-home {
      background-color: white;
      min-height: 100vh;
      max-width: 500px;
      margin: 0 auto;
      padding: 50px 20px 80px;
      position: relative;
    }

    .vote-title {
      font-weight: bold;
      font-size: 20px;
      text-align: center;
      margin-bottom: 4px;
    }

    .meeting-name-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0 24px;
      padding: 0 4px;
    }

    .vote-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(24, 1fr);
      width: 100%;
      height: 480px;
      border: 1px solid #ccc;
    }

    .vote-grid div {
      border: 1px solid #eee;
      cursor: default;
    }

    .vote-grid div.selectable {
      cursor: pointer;
    }

    .vote-grid div.selected {
      background-color: #007bff;
    }

    .hour-label {
      font-size: 12px;
      height: 20px;
    }

    .day-label {
      font-size: 12px;
      text-align: center;
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      justify-content: center;
    }

    .button-row button {
      min-width: 120px;
      height: 40px;
    }
  </style>
</head>
<body>
<main class="form-home">
  <div class="vote-title">ì‹œê°„ íˆ¬í‘œí•˜ê¸°</div>
  <div class="meeting-name-bar">
    <span th:text="${meetingName}">ëª¨ì„ ì´ë¦„</span>
    <button class="btn btn-sm btn-outline-dark" onclick="copyLink()">ë§í¬ ë³µì‚¬</button>
  </div>

  <p th:text="${scheduleTitle}" style="margin-bottom: 10px;">ëª¨ì„ ê°€ëŠ¥ ì‹œê°„</p>

  <!-- ì‹œê°„ ë¼ë²¨ + ìš”ì¼ ë¼ë²¨ + ì…€ -->
  <div style="display: flex;">
    <div style="display: flex; flex-direction: column; margin-right: 4px;">
      <div style="height: 20px;"></div>
      <div th:each="h : ${#numbers.sequence(0, 23)}" class="hour-label">
        <span th:text="${h}"></span>
      </div>
    </div>

    <div style="flex-grow: 1;">
      <div style="display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 2px;">
        <div class="day-label">ì›”</div><div class="day-label">í™”</div><div class="day-label">ìˆ˜</div>
        <div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div>
        <div class="day-label">ì¼</div>
      </div>
      <div id="voteGrid" class="vote-grid">
        <th:block th:each="i : ${#numbers.sequence(0,167)}">
          <div th:attr="data-index=${i}"></div>
        </th:block>
      </div>
    </div>
  </div>

  <div class="button-row">
    <button id="submitVoteBtn" class="btn btn-primary">íˆ¬í‘œ ì œì¶œ</button>
    <button onclick="location.href='/recommendation/'+voteId" class="btn btn-secondary">ì¶”ì²œ ì‹œê°„ ë³´ê¸°</button>
  </div>
</main>

<!-- ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­ -->
<script th:inline="javascript">
  /*<![CDATA[*/
  const voteId = /*[[${voteId}]]*/ null;

  const candidates = /*[[${candidates}]]*/ [];

  // ê¸°ì¤€ ë‚ ì§œ(ì›”ìš”ì¼)
  const weekStart = (() => {
    const now = new Date();
    const day = now.getDay();
    const diff = day === 0 ? -6 : 1 - day;
    now.setDate(now.getDate() + diff);
    now.setHours(0, 0, 0, 0);
    return now;
  })();

  // í›„ë³´ ì¼ì • â†’ ì…€ì— ë§¤í•‘
  candidates.forEach(c => {
    const start = new Date(c.startDate + 'T' + c.startTime);
    const end = new Date(c.startDate + 'T' + c.endTime);

    const dayIndex = (start.getDay() + 6) % 7;
    const startHour = start.getHours();
    const endHour = end.getHours();

    for (let h = startHour; h < endHour; h++) {
      const cellIndex = dayIndex * 24 + h;
      const cell = document.querySelector(`#voteGrid div[data-index="${cellIndex}"]`);
      if (cell) {
        cell.classList.add('selectable');
        cell.dataset.candidateId = c.id;
      }
    }
  });

  // ì…€ í´ë¦­ ì´ë²¤íŠ¸
  document.addEventListener('DOMContentLoaded', function () {
    const voteGrid = document.getElementById('voteGrid');
    const cells = voteGrid.querySelectorAll('div');

    cells.forEach((cell) => {
      if (cell.classList.contains('selectable')) {
        cell.addEventListener('click', () => {
          cell.classList.toggle('selected');
        });
      }
    });

    document.getElementById('submitVoteBtn').addEventListener('click', () => {
      const selectedCandidateIds = Array.from(document.querySelectorAll('.selected'))
          .map(cell => parseInt(cell.dataset.candidateId));
      
      const uniqueIds = [...new Set(selectedCandidateIds)];

      const data = {
        user: "ë³€ì§€ë¯¼",  // TODO: ì‹¤ì œ ì‚¬ìš©ì ì´ë¦„/IDë¡œ ë°”ê¾¸ê¸°
        selectedCandidateIds: uniqueIds
      };

      fetch(`/api/schedule-vote/${voteId}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(response => {
        if (response.ok) {
          alert('âœ… íˆ¬í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
          alert('âŒ ì œì¶œ ì‹¤íŒ¨');
        }
      });
    });
  });

  function copyLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
      alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
    });
  }
  /*]]>*/
</script>
</body>
</html>

console.log("ğŸ‘‰ candidates:", candidates);
console.log("ğŸ‘‰ voteId:", voteId);