<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>시간 투표하기</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background-color: black;
    }

    .form-home {
      background-color: white;
      min-height: 100vh;
      max-width: 500px;
      margin: 0 auto;
      padding: 50px 20px 80px;
      position: relative;
    }

    .vote-title {
      font-weight: bold;
      font-size: 20px;
      text-align: center;
      margin-bottom: 4px;
    }

    .meeting-name-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0 24px;
      padding: 0 4px;
    }

    .vote-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(24, 1fr);
      width: 100%;
      height: 480px;
      border: 1px solid #ccc;
    }

    .vote-grid div {
      border: 1px solid #eee;
      cursor: default;
    }

    .vote-grid div.selectable {
      cursor: pointer;
    }

    .vote-grid div.selected {
      background-color: #007bff;
    }

    .hour-label {
      font-size: 12px;
      height: 20px;
    }

    .day-label {
      font-size: 12px;
      text-align: center;
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      justify-content: center;
    }

    .button-row button {
      min-width: 120px;
      height: 40px;
    }
  </style>
</head>
<body>
<main class="form-home">
  <div class="vote-title">시간 투표하기</div>
  <div class="meeting-name-bar">
    <span th:text="${meetingName}">모임 이름</span>
    <button class="btn btn-sm btn-outline-dark" onclick="copyLink()">링크 복사</button>
  </div>

  <p th:text="${scheduleTitle}" style="margin-bottom: 10px;">모임 가능 시간</p>

  <!-- 시간 라벨 + 요일 라벨 + 셀 -->
  <div style="display: flex;">
    <div style="display: flex; flex-direction: column; margin-right: 4px;">
      <div style="height: 20px;"></div>
      <div th:each="h : ${#numbers.sequence(0, 23)}" class="hour-label">
        <span th:text="${h}"></span>
      </div>
    </div>

    <div style="flex-grow: 1;">
      <div style="display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 2px;">
        <div class="day-label">월</div><div class="day-label">화</div><div class="day-label">수</div>
        <div class="day-label">목</div><div class="day-label">금</div><div class="day-label">토</div>
        <div class="day-label">일</div>
      </div>
      <div id="voteGrid" class="vote-grid">
        <th:block th:each="i : ${#numbers.sequence(0,167)}">
          <div th:attr="data-index=${i}"></div>
        </th:block>
      </div>
    </div>
  </div>

  <div class="button-row">
    <button id="submitVoteBtn" class="btn btn-primary">투표 제출</button>
    <button onclick="location.href='/recommendation/'+voteId" class="btn btn-secondary">추천 시간 보기</button>
  </div>
</main>

<!-- 스크립트 영역 -->
<script th:inline="javascript">
  /*<![CDATA[*/
  const voteId = /*[[${voteId}]]*/ null;

  const candidates = /*[[${candidates}]]*/ [];

  // 기준 날짜(월요일)
  const weekStart = (() => {
    const now = new Date();
    const day = now.getDay();
    const diff = day === 0 ? -6 : 1 - day;
    now.setDate(now.getDate() + diff);
    now.setHours(0, 0, 0, 0);
    return now;
  })();

  // 후보 일정 → 셀에 매핑
  candidates.forEach(c => {
    const start = new Date(c.startDate + 'T' + c.startTime);
    const end = new Date(c.startDate + 'T' + c.endTime);

    const dayIndex = (start.getDay() + 6) % 7;
    const startHour = start.getHours();
    const endHour = end.getHours();

    for (let h = startHour; h < endHour; h++) {
      const cellIndex = dayIndex * 24 + h;
      const cell = document.querySelector(`#voteGrid div[data-index="${cellIndex}"]`);
      if (cell) {
        cell.classList.add('selectable');
        cell.dataset.candidateId = c.id;
      }
    }
  });

  // 셀 클릭 이벤트
  document.addEventListener('DOMContentLoaded', function () {
    const voteGrid = document.getElementById('voteGrid');
    const cells = voteGrid.querySelectorAll('div');

    cells.forEach((cell) => {
      if (cell.classList.contains('selectable')) {
        cell.addEventListener('click', () => {
          cell.classList.toggle('selected');
        });
      }
    });

    document.getElementById('submitVoteBtn').addEventListener('click', () => {
      const selectedCandidateIds = Array.from(document.querySelectorAll('.selected'))
          .map(cell => parseInt(cell.dataset.candidateId));
      
      const uniqueIds = [...new Set(selectedCandidateIds)];

      const data = {
        user: "변지민",  // TODO: 실제 사용자 이름/ID로 바꾸기
        selectedCandidateIds: uniqueIds
      };

      fetch(`/api/schedule-vote/${voteId}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(response => {
        if (response.ok) {
          alert('✅ 투표가 성공적으로 제출되었습니다!');
        } else {
          alert('❌ 제출 실패');
        }
      });
    });
  });

  function copyLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
      alert("링크가 복사되었습니다!");
    });
  }
  /*]]>*/
</script>
</body>
</html>

console.log("👉 candidates:", candidates);
console.log("👉 voteId:", voteId);